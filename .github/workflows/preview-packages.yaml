name: 📦 Preview Packages

# Run on pushes to branches (excluding master and next) after tests pass
on:
  workflow_run:
    workflows: ["🧪 Test code"]
    types:
      - completed
    branches:
      - "**"
      - "!master"
      - "!next"

env:
  HUSKY: 0

jobs:
  preview-package:
    # Only run if tests passed and commit contains [img:tag-name] pattern
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      # Checkout repository
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 2

      # Check if commit contains preview package pattern
      - name: 🔍 Check for preview package pattern
        id: check-pattern
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          if [[ "$COMMIT_MSG" =~ \[img:([^\]]+)\] ]]; then
            TAG_NAME="${BASH_REMATCH[1]}"
            echo "Preview package detected with tag: $TAG_NAME"
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "No preview package pattern found"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

      # Setup Node if we need to publish
      - name: 📦 Setup Node.js
        if: steps.check-pattern.outputs.should_publish == 'true'
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      # Enable corepack
      - name: ⚙️ Enable corepack
        if: steps.check-pattern.outputs.should_publish == 'true'
        run: corepack enable && corepack enable npm

      # Install dependencies
      - name: 📦 Install dependencies
        if: steps.check-pattern.outputs.should_publish == 'true'
        run: npm ci

      # Create preview package version
      - name: 📋 Create preview version
        if: steps.check-pattern.outputs.should_publish == 'true'
        id: version
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"

          # Create preview version by incrementing patch and adding tag
          TAG_NAME="${{ steps.check-pattern.outputs.tag_name }}"

          # Split version into parts
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          # Increment patch version
          NEW_PATCH=$((PATCH + 1))
          PREVIEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH-$TAG_NAME"

          echo "Preview version: $PREVIEW_VERSION"
          echo "preview_version=$PREVIEW_VERSION" >> $GITHUB_OUTPUT

          # Update package.json with preview version
          npm version "$PREVIEW_VERSION" --no-git-tag-version

      # Publish preview package to npm
      - name: 🚀 Publish preview package
        if: steps.check-pattern.outputs.should_publish == 'true'
        run: |
          TAG_NAME="${{ steps.check-pattern.outputs.tag_name }}"
          PREVIEW_VERSION="${{ steps.version.outputs.preview_version }}"

          echo "Publishing version $PREVIEW_VERSION with tag $TAG_NAME"
          npm publish --tag "$TAG_NAME" --access public

          echo "✅ Preview package published successfully!"
          echo "📦 Install with: npm install astro-loader-pocketbase@$TAG_NAME"
          echo "🔖 Version: $PREVIEW_VERSION"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Comment on PR if this is from a pull request
      - name: 💬 Comment on PR
        if: steps.check-pattern.outputs.should_publish == 'true' && github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = '${{ steps.check-pattern.outputs.tag_name }}';
            const previewVersion = '${{ steps.version.outputs.preview_version }}';

            const comment = `🎭 **Preview Package Published**

            A preview version of this package has been published to npm:

            \`\`\`bash
            npm install astro-loader-pocketbase@${tagName}
            \`\`\`

            **Version:** \`${previewVersion}\`  
            **Tag:** \`${tagName}\`

            This preview package can be used to test changes before merging.`;

            // Find the PR number from the workflow run
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${{ github.event.workflow_run.head_branch }}`,
              state: 'open'
            });

            if (prs.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs.data[0].number,
                body: comment
              });
            }
